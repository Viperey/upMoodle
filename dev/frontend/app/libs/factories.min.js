angular.module("upmApp").factory("api",function($http,$cookies,$upload,$window){var base_url="http://127.0.0.1:8000/",user_pics_url=base_url;return{getPic:function(url){return user_pics_url+url},getUser:function(){return $http({method:"GET",url:base_url+"user/"})},updateUserSubjects:function(subjects){return $http({method:"post",url:base_url+"user/subjects/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{ids:subjects||[]}})},updateUser:function(user){return $http({method:"POST",url:base_url+"user/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:user.password?{email:user.email,name:user.name,nick:user.nick,password:user.password}:{email:user.email,name:user.name,nick:user.nick}})},updateUserProfilePic:function(profilePic){return console.log(profilePic),$http({method:"POST",url:base_url+"user/profilePic/",headers:{"Content-Type":"multipart/form-data"},data:{profilePic:profilePic},transformRequest:function(data,headersGetter){var formData=new FormData;angular.forEach(data,function(value,key){formData.append(key,value)});var headers=headersGetter();return delete headers["Content-Type"],formData}})},login:function(userEmail,userPassword){return $http({method:"post",url:base_url+"login/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{email:userEmail,password:userPassword}})},signup:function(user){return $http({method:"post",url:base_url+"signup/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{email:user.email,password:user.password,nick:user.nick,name:user.name}})},logout:function(){return $http({method:"POST",url:base_url+"logout/"})},recoverPassword:function(email){return $http({method:"POST",url:base_url+"recover_password/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{email:email}})},confirmEmail:function(token){return $http({method:"POST",url:base_url+"confirm_email/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{token:token}})},subjectsTree:function(){return $http({method:"GET",url:base_url+"subjectsTree/"})},notesByLevelId:function(level,recursive){return $http({method:"GET",url:base_url+"level/"+level+"/notes?recursive="+recursive})},notePut:function(note){return $http({method:"PUT",url:base_url+"note/"+note.id+"/",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{text:note.text,topic:note.topic,level_id:note.level.id}})},notePost:function(note){return $http({method:"post",url:base_url+"note/",headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{text:note.text,topic:note.topic,level_id:note.level_id}})},noteDelete:function(noteId){return $http["delete"](base_url+"note/"+noteId+"/")},subjectFiles:function(subjectId){return $http({method:"GET",url:base_url+"subject/"+subjectId+"/files"})},fileTypesGet:function(){return $http({method:"GET",url:base_url+"fileTypes/"})},uploadFile:function(file,data){return $http({method:"POST",url:base_url+"file/",headers:{"Content-Type":"multipart/form-data"},data:{subject_id:data.subjectId,uploader_id:data.userId,name:data.fileInfo.name,text:data.fileInfo.text,fileType_id:data.fileType.id,file:file},transformRequest:function(data,headersGetter){var formData=new FormData;angular.forEach(data,function(value,key){formData.append(key,value)});var headers=headersGetter();return delete headers["Content-Type"],formData}})},filePost:function(file){return $http({method:"PUT",url:base_url+"file/"+file.hash,headers:{"Content-Type":"application/json"},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{text:file.text,name:file.name,fileType_id:file.fileType.id}})},fileGet:function(hash){return $http.get(base_url+"file/"+hash,{headers:{Accept:"application/json"}})},fileDownload:function(hash){var url=base_url+"file/"+hash;$window.open(url)},fileDelete:function(hash){return $http["delete"](base_url+"file/"+hash)}}}),angular.module("upmApp").factory("SubjectsTree",["$location","api",function($location,api){var returno={model:void 0,get:function(){return void 0===this.model?api.subjectsTree().then(function(response){return returno.model=response.data[0],returno.model},function(){return null}):this.model},set:function(model){this.model=model},destroy:function(){returno.model=void 0},getLevel:function(id,node){var that=this;if(node=node||this.model,node.id==id)return node;if(node.children){var returno=null;return angular.forEach(node.children,function(children){returno||(candidateNode=that.getLevel(id,children),candidateNode&&(returno=candidateNode))}),returno}return null}};return returno}]),angular.module("upmApp").factory("User",["$location","api",function($location,api){var returno={model:void 0,destroy:function(){this.model=void 0},get:function(){return void 0===this.model?api.getUser().then(function(response){return returno.model=response.data,returno.model},function(){return $location.path("/login"),!1}):this.model},set:function(model){this.model=model},isSignedInSubject:function(id){return returno=!1,angular.forEach(this.model.subjects,function(value){value.id===id&&(returno=!0)}),returno}};return returno}]);